version: "3.9"

services:
  hf-embeddings:
    image: ghcr.io/huggingface/text-embeddings-inference:latest
    container_name: hf-embeddings
    restart: unless-stopped

    ports:
      - "8080:8080"

    environment:
      NVIDIA_VISIBLE_DEVICES: "all"
      NVIDIA_DRIVER_CAPABILITIES: "compute,utility"
      HF_HUB_ENABLE_HF_TRANSFER: "1"

    command:
      - "--model-id"
      - "BAAI/bge-m3"
      - "--hostname"
      - "0.0.0.0"
      - "--port"
      - "8080"
      - "--max-client-batch-size"
      - "128"
      - "--max-batch-tokens"
      - "16384"
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4096M
    gpus: all
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8080/health"]
      interval: 10s
      timeout: 2s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.hf-embeddings.rule=PathPrefix(`/embeddings`)"
      - "traefik.http.routers.hf-embeddings.middlewares=hf-embeddings-stripprefix"
      - "traefik.http.middlewares.hf-embeddings-stripprefix.stripprefix.prefixes=/embeddings"
